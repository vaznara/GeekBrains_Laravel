# Домащнее задание №9

Что реализовано:

- Добавлена возможность авторизации через Google, Facebook и GitHub.
- Добавлен парсер новостей с сайта **[lenta.ru](http://lenta.ru)**
- Были учтены замечания к домашнему заданию №8

Ниже найдете подробное описание функционала

## Авторизация через соц. сети

Вместо создания репозитория, как это было реализовано на уроке и в методичке, я решил сделать с помощью новой модели SocialUser.

Это сделано для того, чтобы один пользователь смог авторизоваться через разные соц. сети.

###
####ЧТО БЫЛО СДЕЛАНО:

- [x] Добавлена новая модель и таблица в БД SocialUser и social_users, таблицы связаны с помощью ID пользователя в приложений.

- [x] При авторизации пользователя через соц. сети, проверяется есть ли у нас в базе пользователь с таким email, если нет создаем нового пользователя и генерируем для него случайный пароль.

- [x] Если пользователь есть, тогда проверятся есть ли у нас в таблице social_users запись для данного пользователя с этой соц. сети. Если записи нет, она создается. После авторизуем пользователя. 

- [x] Функционал реализован уникальным контроллером и функциями в новой модели, соц. сеть, через которого необходимо авторизовать пользователя передаем из вьюхи.

###
####КАК ЗАПУСТИТЬ:

Чтобы у вас все заработало, вам необходимо взять из репозитория мой env файл, заменив настройки для подключений к БД, а также запустить проект с помощью команды npm run watch, т.к. во всех соц. сетях прописан редирект на localhost:3000.
 

## Парсер новостей

Реализован парсер новостей, добавлена кнопка "Спарсить новости" в пункте меню "Админка". 

###
####ЧТО БЫЛО СДЕЛАНО:

- [x] Всю логику я добавил в модели News, в контроллере ParserController оставил только парсер и редирект.
- [x] Расширил таблицу news: добавил поля img_uri и published_at
- [x] В таблице новостей поля published_at и title сделал уникальными.
- [x] Если при парсинге нарушается уникальность данных полей, отлавливаю exception с кодом SQL 23000 и добавляю заголовок такой новости в массив для отображения пользователю.
- [x] Если длина этого массива == кол-ву новостей, тогда показываю пользователю сообщение, что новых новостей нет, если же нет, тогда показываю список новостей, которые не были добавлены в базу.
- [x] Переделал логику отображения картинки во вьюхе: если есть локальная картинка, отображается она, если нет, тогда отображается картинка полученная из парсинга, если и там нет картинки, тогда отображается картинка по умолчанию.
- [x] Данный источник также предоставляет категорий новостей, поэтому я проверяю есть ли такая категория в базе, если ее нет, то создаю. Если новость приходит без категорий, добавляю в категорию по умолчанию, которая создается при посеве.

## Замечания к ДЗ №8

Замечание | Ответ
------------ | -------------
*Зависимость "ext-http": "*" у меня не ставится, откуда она вообще у вас? | Удалил, это шторм предложил добаивть.
*Сделали профиль, но можно менять только пароль, а что остальные данные? И при смене пароля обычно спрашивают старый, так забудете где-то разлогиниться, а кто нибудь сменит вам пароль и ппц.* | Сделал запрос старого пароля, но профиль у меня задуман в будущем, как модель. Там сейчас у пользователя только имя и email, думаю пользователь и не должен их менять сам. Поэтому пока добавил только смену пароля.
*В правке новостей та же проблема что и на лекции, пустое тело меняется на полную новость при фейле валидации.* | Не совсем так, он возвращает тело из хелпера old, не из базы, он же не пустым был перед отправкой, чтобы пустой возращать? Разве не так должно быть? На лекции он возвращал из базы.
*У меня не подгружаются картинки edit и delete, видимо в storage они. а он в гитигноре, да точно, взял из архива их.* | Добавил в исключения в .gitignore, сейчас должно загрузиться.
*Ох даже целый crud пользователей сделали. В Email подтвержден вижу нет@elseда косяк шаблона?* | У меня отображается нормально. Может у вас из-за кеша вьюхи так отображается? Переписал на синтакс с переводами: __('нет'), может поможет.
*Форму для правки пользователя использовали форму профиля, вот ее надо было сделать всем пользователям, а админу хотя бы роль, а так не понятно что писать в новый пароль, не совсем прозрачно, что если ничего не написать, пароль сохранится. Но роль сменилась, зашел админом, в плане функционала тут все ок.* | Сделал поле паролей неактивным и добавил кнопку "Сменить пароль" и скрипт. Если пароль оставить пустым, он не обновится в базе.
*Вот вадилация через посредник, чисто для примера, в данном простом сайте так может и не нужно.* | Убрать валидацию через посредник? Сделал согласно заданию :)
*if($user->id == 1) это так главного админа проверяете, он точно всегда будет с id=1? И не главный админ не должен снимать себя с админа, тут нужно продумать еще. Раз сделали роли, можно сделать и суперадмина, что только он может управлять админами, а другие нет.* | Добавил признак is_admin в БД, который будет использоваться только для главного админа.
*ChangePasswordController я бы в контроллерах админа оставил. Все же это функционал админа.* |  ChangePasswordController - не для админа, а для всех. У админа контроллер UserController для изменения всех пользователей.

#### Спасибо! Жду новых замечаний.
